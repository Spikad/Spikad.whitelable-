# üîç Deep Codebase Audit Report
**Spikad.ai Platform | February 19, 2026**

---

## 1. Database Integrity Issues

### üî¥ CRITICAL: Missing Table: `affiliate_payouts`
**File**: `src/components/dashboard/AffiliateDashboard.tsx` (Line 81, 127)
- Component tries to query: `.from('affiliate_payouts')`
- **DATABASE TRUTH**: Table doesn't exist. Only `referrals` table exists (migration line 195)
- **Impact**: Payout tracking completely non-functional. Falls back to mock data silently
- **Remediation**: Either (a) Use `referrals` table instead, OR (b) Create `affiliate_payouts` table in new migration

### üî¥ CRITICAL: Missing Column: `bookings.notes`
**File**: `src/components/dashboard/AppointmentsList.tsx` (Lines 61, 265, 270)
- Component tries to: `update({ notes: newNotes })`
- **DATABASE TRUTH**: `bookings` table (migration line 78-88) has NO notes column
- **Columns that exist**: id, tenant_id, product_id, customer_id, start_time, end_time, status, created_at
- **Impact**: Admin notes feature crashes on save
- **Remediation**: Add migration: `ALTER TABLE bookings ADD COLUMN notes text;`

### ‚ö†Ô∏è WARNING: Missing Enum Value: `bookings.status`
**File**: `src/components/dashboard/AppointmentsList.tsx` (Line 19, 183)
- Component uses status: `'no-show'` (line 19)
- **DATABASE TRUTH**: Enum only allows: `'pending','confirmed','cancelled','completed'` (migration line 86)
- **Impact**: Marking appointment as "no-show" will fail with constraint violation
- **Remediation**: `ALTER TYPE public.product_type ADD VALUE 'no-show';` OR remove feature

### ‚ö†Ô∏è WARNING: Unused Product Columns
**File**: `src/components/dashboard/ProductForm.tsx` vs `20260218190000_enhance_products_schema.sql`
- Database has these columns: `seo_title`, `seo_description`, `tags`, `options`, `category`
- ProductForm implements: `category` ‚úì, `images` ‚úì, `options` ‚úì
- **MISSING UI**: `seo_title`, `seo_description`, `tags[]`
- **Impact**: 30% of product metadata can't be set through UI (dead columns)
- **Remediation**: Add SEO section to ProductForm

### ‚ö†Ô∏è WARNING: Missing RLS Security Policies
**File**: `supabase/migrations/20260218220000_master_roadmap.sql` (Lines 301-376)
- All RLS policies are **COMMENTED OUT** with note: "Temporarily Disabled"
- **RISK**: Multi-tenant data completely unprotected. Any user can read/write any other tenant's data
- **Affected tables**: bookings, availability_slots, pages, blog_posts, shipments, returns, email_campaigns, etc. (15+ tables)
- **Remediation**: URGENT - Uncomment and test RLS policies before production

### ‚ö†Ô∏è WARNING: Metadata Column Not Fully Used
**File**: `src/components/storefront/BookingWidget.tsx` (Line 113)
- Component inserts: `metadata: { customer_phone: customerInfo.phone }`
- But bookings table has no `metadata` column defined (only JSONB on affiliate_payouts doesn't exist)
- **Impact**: Booking phone data will fail to save
- **Remediation**: Add `ALTER TABLE bookings ADD COLUMN metadata jsonb DEFAULT '{}'::jsonb;`

---

## 2. Frontend Logic Gaps

### üî¥ CRITICAL: Category Assignment Not Implemented
**Component**: `BlogManager.tsx`
- **Fetches**: category_id from database (line 76)
- **Displays**: Category list in sidebar (lines 484-499)
- **Creates/Updates**: WITHOUT category_id (lines 108-127, 137-158)
- **Code Audit**:
  ```tsx
  // Line 112-121: createPost() - NO category_id
  const { data, error } = await supabase
    .from('blog_posts')
    .insert({
      tenant_id: tenantId,
      title: newTitle,
      slug: newSlug,
      content: newContent || null
      // ‚ùå MISSING: category_id
    })
  
  // Line 142-149: updatePost() - NO category_id
  const { error } = await supabase
    .from('blog_posts')
    .update({
      title: newTitle,
      slug: newSlug,
      content: newContent
      // ‚ùå MISSING: category_id
    })
  ```
- **Impact**: Categories display but never save. Every post has NULL category
- **Remediation**: Add category selector dropdown and include category_id in insert/update

### ‚ö†Ô∏è WARNING: Affiliate Dashboard - Mock Data Fallback
**Component**: `AffiliateDashboard.tsx` (Lines 81-92)
- Fetches from wrong table name ‚Üí Supabase returns null ‚Üí Falls back to hardcoded mockPayouts
- User sees: demo data, not real affiliate payouts
- **Code**:
  ```tsx
  const { data: payoutData } = await supabase
    .from('affiliate_payouts')  // ‚ùå TABLE DOESN'T EXIST
    .select(...)
  
  const mockPayouts: PayoutRecord[] = [...]  // ‚úì Used as fallback
  setPayouts(payoutData || mockPayouts)  // Always uses mock
  ```
- **User Impact**: Can't track real payouts, no warnings shown
- **Remediation**: Use `referrals` table OR create `affiliate_payouts` migration

### ‚ö†Ô∏è WARNING: VariantEditor Not Fully Implemented
**Component**: `ProductForm.tsx`
- Uses VariantEditor for options (line 135)
- VariantEditor component loads (component exists)
- BUT: No validation that options are properly saved as JSONB
- **Risk**: Complex variant data might corrupt on save
- **Remediation**: Add validation + testing for variant JSON schema

### ‚ö†Ô∏è WARNING: Image Gallery Not Integrated
**Component**: `ProductForm.tsx` missing MultiImageUploader integration
- MultiImageUploader exists as component (line 9 import)
- But NOT USED in the form
- Code comment says "// Image Gallery" but no actual uploader (post line 160)
- **Impact**: Can't upload multiple images through UI
- **Remediation**: Add actual MultiImageUploader component

---

## 3. UI/UX & Design System Inconsistencies

### üé® CRITICAL: Inconsistent Input Styling
**Issue**: Mixed `rounded-lg` and `rounded-md` for identical input elements

**Affected Components**:
- `AvailabilitySettings.tsx`: 
  - Line 210: `rounded-lg` (timezone select)
  - Line 244: `rounded-md` (time input)
  - Line 253: `rounded-md` (time input)
- `AppointmentsList.tsx`:
  - Line 258: `rounded-lg` (notes textarea)
  - Mixed in reschedule modal

**Standard**: Tailwind recommends `rounded-lg` for all form elements (consistency with body text)

**Remediation**: Replace all `rounded-md` with `rounded-lg` in form inputs

---

### üé® Padding & Spacing Inconsistencies
**Issue**: Inconsistent use of `p-4` vs `p-6` in similar card contexts

| Component | Section | Padding | Status |
|-----------|---------|---------|--------|
| AvailabilitySettings | Main card | `p-6` | ‚úì Correct |
| AvailabilitySettings | Info panels | `p-4` | Mixed |
| AppointmentsList | Card header | `p-6` | ‚úì Correct |
| AppointmentsList | Individual rows | `p-6` | ‚úì Correct |
| BlogManager | Card | `p-6` | ‚úì Correct |
| EmailMarketing | Header | `p-6` | ‚úì Correct |

**Standard**: `p-6` for card padding, `p-4` for internal sections/panels

**Remediation**: Normalize to `p-6` for primary containers, `p-4` for nested sections

---

### üé® Color Inconsistency: Primary Button Shades
**Issue**: Multiple shades of blue used for primary actions

```
Found:
- bg-blue-600 (primary buttons in 12+ components) ‚úì Standard
- bg-indigo-600 (rare, ProductForm line ~175 hover state)
- bg-purple-600 (AvailabilitySettings bulk edit, AppointmentsList reschedule)
- bg-cyan-600 (form buttons)
```

**Remediation**: 
- Primary actions: `bg-blue-600`
- Secondary/special: Use purple/indigo ONLY where semantically necessary
- Create Tailwind config constant: `primaryButton: 'bg-blue-600 hover:bg-blue-700'`

---

### üì± Mobile Responsiveness Issues

#### ‚ö†Ô∏è WARNING: AppointmentsList Grid Collapse
**Component**: `AppointmentsList.tsx` (Line 238)
```tsx
<div className="grid grid-cols-2 gap-4 mb-4 text-sm">  // ‚ùå 2 columns always
  <div>Calendar</div>
  <div>Clock Time</div>
</div>
```
- On mobile (< 640px): 2 columns cramped
- **Fix**: `grid grid-cols-1 sm:grid-cols-2 gap-4`

#### ‚ö†Ô∏è WARNING: AffiliateDashboard Withdrawal Form
**Component**: `AffiliateDashboard.tsx` (Line 281)
```tsx
<div className="grid grid-cols-2 gap-4">  // ‚ùå Always 2 columns
  <input amount />
  <select method />
</div>
```
- On mobile: Inputs too narrow
- **Fix**: `grid grid-cols-1 sm:grid-cols-2 gap-4`

#### ‚úì GOOD: BookingWidget Calendar
- Uses responsive `grid-cols-5 md:grid-cols-6 lg:grid-cols-7` (Line 149)
- Properly adaptive

---

### üî¥ Dead Ends & Non-Functional UI Elements

#### 1. **BlogManager Categories**
- Categories displayed in sidebar (lines 484-499)
- Category creation works ‚úì
- But: Category selection on post creation **NOT IMPLEMENTED**
- User sees categories but can't assign them
- **Fix Needed**: Add `<select>` or `<buttons>` to assign category_id

#### 2. **ProductForm Tags**
- Database has `tags text[]` column
- ProductForm doesn't have tags UI
- User can't set tags
- **Impact**: Tags field always NULL

#### 3. **ProductForm SEO**
- Database has `seo_title`, `seo_description` columns
- ProductForm missing UI for these
- **Impact**: SEO metadata never saved

---

## 4. Architecture & Performance Issues

### ‚ö†Ô∏è Data Synchronization Gaps

| Feature | DB Column | React State | Persists | Status |
|---------|-----------|------------|----------|--------|
| Blog Categories | ‚úì | ‚úì | ‚ùå No | Post saved without category |
| Appointment Notes | ‚ùå Missing | ‚úì | N/A Fails | Column doesn't exist |
| Product Tags | ‚úì | ‚ùå Missing UI | N/A Fails | No UI to set |
| Product SEO | ‚úì | ‚ùå Missing UI | N/A Fails | No UI to set |
| Booking Notes | ‚ùå Missing | ‚úì | N/A Fails | Column doesn't exist |
| Affiliate Payouts | ‚ùå Wrong Table | ‚úì Mock | ‚ùå Mock Only | Uses non-existent table |

---

### ‚ö†Ô∏è Component State Management Issues

**File**: `BlogManager.tsx`
- Fetches categories (line 77): ‚úì
- Displays categories list: ‚úì
- Has state for `newTitle`, `newSlug`, `newContent`: ‚úì
- **MISSING**: selectedCategoryId state
- **Impact**: No way to select category before save

---

## 5. Security Issues

### üî¥ CRITICAL: RLS Policies Disabled
- **Status**: Commented out (migration lines 301-376)
- **Risk Level**: CRITICAL - Production security vulnerability
- **Affected**: All 15+ multi-tenant tables
- **Exploit**: Any authenticated user can query/modify any tenant's data
- **Remediation**: 
  1. Uncomment RLS policies
  2. Test each policy with wrong tenant_id
  3. Verify super_admin bypass works
  4. Deploy as production hotfix

### ‚ö†Ô∏è WARNING: No Input Validation on Sensitive Fields
- Service duration in BookingWidget: Can be negative (no min check)
- Buffer time: No validation
- **Fix**: Add HTML5 `min="0"` attribute

---

## 6. Remediation Plan (Priority Order)

### PHASE 1: Critical Fixes (Do Immediately)
```markdown
1. ‚úÖ Enable RLS Policies
   - Uncomment migration 20260218220000 lines 301-376
   - Test with multiple test tenants
   - Deploy as hotfix

2. ‚úÖ Fix AffiliateDashboard Table Name
   - Option A: Change component to use referrals table
   - Option B: Create affiliate_payouts migration
   - Recommended: Option B (proper separation)

3. ‚úÖ Add bookings.notes Column
   - New migration: add_bookings_notes.sql
   - ALTER TABLE bookings ADD COLUMN notes text;

4. ‚úÖ Add bookings Status Enum Value
   - ALTER TYPE public.product_type ADD VALUE 'no-show';
   - OR remove no-show feature from AppointmentsList

5. ‚úÖ Add bookings.metadata Column
   - ALTER TABLE bookings ADD COLUMN metadata jsonb DEFAULT '{}'::jsonb;
```

### PHASE 2: Logic Fixes (This Sprint)
```markdown
1. BlogManager - Add Category Selector
   - Add state: const [selectedCategoryId, setSelectedCategoryId]
   - Add dropdown UI with categories
   - Include category_id in insert/update queries
   - Est. 1 hour

2. ProductForm - Add Missing Fields UI
   - Add SEO Title input
   - Add SEO Description textarea
   - Add Tags comma-separated input
   - Convert tags string ‚Üí tags array on save
   - Est. 2 hours

3. ProductForm - Integrate MultiImageUploader
   - Remove comment placeholder
   - Add actual MultiImageUploader component
   - Connect to images state
   - Est. 1.5 hours

4. ProductForm - Add Validation
   - Service duration: min="1"
   - Buffer time: min="0"
   - Price: min="0" step="0.01"
   - Est. 30 min
```

### PHASE 3: UI/UX Standardization (Next Sprint)
```markdown
1. Form Input Styling
   - Replace all rounded-md ‚Üí rounded-lg
   - Files affected: AvailabilitySettings, AppointmentsList, multiple forms
   - Est. 30 min

2. Padding Consistency
   - Audit all p-4 vs p-6 usage
   - Standardize: p-6 cards, p-4 panels
   - Est. 20 min

3. Mobile Responsiveness
   - Fix AppointmentsList grid ‚Üí grid-cols-1 sm:grid-cols-2
   - Fix AffiliateDashboard form ‚Üí same responsive pattern
   - Est. 20 min

4. Button Color Consistency
   - Verify all primary buttons use bg-blue-600
   - Reserve purple/indigo for special actions only
   - Est. 30 min
```

---

## 7. Summary Statistics

| Category | Count | Status |
|----------|-------|--------|
| **Total Tables** | 25 | ‚úì Documented |
| **Components Audited** | 20 | ‚ö†Ô∏è 5+ with issues |
| **Critical Issues** | 4 | üî¥ Blocks functionality |
| **Warnings** | 8 | ‚ö†Ô∏è Data loss risk |
| **UI Inconsistencies** | 12+ | üé® Polish needed |
| **Estimated Fix Time** | - | **8-10 hours** |

---

## 8. Test Cases to Validate Fixes

```sql
-- 1. Test RLS After Uncommenting
SELECT * FROM bookings WHERE tenant_id != auth.uid()::uuid; -- Should fail

-- 2. Verify affiliate_payouts table operations
INSERT INTO affiliate_payouts VALUES (...);
SELECT * FROM affiliate_payouts WHERE tenant_id = $1;

-- 3. Test bookings.notes persistence
UPDATE bookings SET notes = 'Important info' WHERE id = $1;
SELECT notes FROM bookings WHERE id = $1; -- Should return 'Important info'

-- 4. Test no-show status
UPDATE bookings SET status = 'no-show' WHERE id = $1;
SELECT status FROM bookings WHERE id = $1; -- Should succeed
```

---

**Audit Completed**: February 19, 2026  
**Auditor**: Senior Full-Stack Code Assistant  
**Overall Health**: ‚ö†Ô∏è **Production-Ready with Critical Fixes Required**
